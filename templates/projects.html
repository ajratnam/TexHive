<!DOCTYPE html>
<html lang="en">
<head>
  {% include 'partials/head.html' %}
  <style>
    .dialog-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .dialog-content {
        padding: 1.5rem;
        border-radius: 0.5rem;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    /* Light theme */
    :root[data-theme="light"] .dialog-content {
        background-color: white;
        color: #1a1a1a;
    }

    /* Dark theme */
    :root[data-theme="dark"] .dialog-content {
        background-color: #1a1a1a;
        color: #ffffff;
    }

    :root[data-theme="dark"] .dialog-header {
        border-bottom: 1px solid #333;
    }

    :root[data-theme="dark"] .dialog-footer {
        border-top: 1px solid #333;
    }

    :root[data-theme="dark"] .collaborator-item {
        border-bottom: 1px solid #333;
    }

    :root[data-theme="dark"] .text-gray-500 {
        color: #9ca3af;
    }

    :root[data-theme="dark"] .text-gray-600 {
        color: #d1d5db;
    }

    :root[data-theme="dark"] .bg-gray-200 {
        background-color: #374151;
    }

    :root[data-theme="dark"] .hover\:bg-gray-300:hover {
        background-color: #4b5563;
    }

    .dialog-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .dialog-body {
        margin-bottom: 1rem;
    }

    .collaborator-list {
        max-height: 300px;
        overflow-y: auto;
    }

    .collaborator-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .collaborator-item:last-child {
        border-bottom: none;
    }

    .dialog-footer {
        display: flex;
        justify-content: flex-end;
        padding-top: 1rem;
        border-top: 1px solid #e5e7eb;
    }
  </style>
</head>
<body class="h-screen">
  <header class="flex items-center justify-between px-4 py-3 bg-header-color text-text-color">
  <div class="flex items-center">
    <a href="/">
      <h1 class="text-2xl font-bold">TexHive</h1>
    </a>
  </div>
  <div class="flex items-center space-x-4">
    <select id="theme-selector">
      <option value="dark">Dark</option>
      <option value="light">Light</option>
      <option value="solarized">Solarized</option>
      <option value="dracula">Dracula</option>
      <option value="monokai">Monokai</option>
      <option value="nord">Nord</option>
      <option value="gruvbox">Gruvbox</option>
      <option value="cobalt">Cobalt</option>
    </select>
    <!-- User profile icon -->
    <div id="user-profile-container" class="relative">
      <div id="user-profile-icon" class="w-8 h-8 rounded-full bg-gray-300 cursor-pointer"></div>
      <div id="user-profile-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white shadow-lg rounded-lg p-4">
        <p id="user-name" class="font-bold"></p>
        <p id="user-email" class="text-sm text-gray-600"></p>
        <button id="logout-btn" class="mt-4 px-4 py-2 bg-red-500 text-white rounded w-full" onclick="handleLogout()">
          Logout
        </button>
      </div>
    </div>
  </div>
</header>

<!-- Add collaborators dialog -->
<dialog id="collaborators-dialog" class="bg-transparent">
    <div class="p-6 bg-[#1e1e1e] text-white min-w-[500px] rounded-lg shadow-xl">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold">Project Collaborators</h2>
            <button onclick="closeCollaboratorsDialog()" class="text-gray-400 hover:text-white text-2xl leading-none" aria-label="Close dialog">&times;</button>
        </div>

        <div class="space-y-6">
            <!-- Owner Section -->
            <div>
                <h3 class="text-gray-400 text-sm capitalize tracking-wider mb-3">Owner</h3>
                <div id="owner-info" class="py-2"></div>
            </div>

            <!-- Collaborators Section -->
            <div>
                <h3 class="text-gray-400 text-sm capitalize tracking-wider mb-3">Collaborator</h3>
                <div id="collaborators-list" class="space-y-2"></div>
                <div id="no-collaborators" class="text-gray-500 py-3">No collaborators yet</div>
            </div>
        </div>
    </div>
</dialog>

<script>
  const profileIcon = document.getElementById('user-profile-icon');
  const profileDropdown = document.getElementById('user-profile-dropdown');
  const userName = document.getElementById('user-name');
  const userEmail = document.getElementById('user-email');

  // Function to update profile UI
  function updateProfile(user) {
    if (user) {
      profileIcon.style.backgroundImage = `url(${user.photoURL || ''})`;
      profileIcon.style.backgroundSize = 'cover';
      userName.textContent = user.displayName || '';
      userEmail.textContent = user.email || '';
    } else {
      profileIcon.style.backgroundImage = '';
      userName.textContent = '';
      userEmail.textContent = '';
    }
  }

  // Toggle dropdown
  profileIcon.addEventListener('click', () => {
    profileDropdown.classList.toggle('hidden');
  });

  // Try loading from sessionStorage first
  try {
    const sessionData = JSON.parse(sessionStorage.getItem('userDetails'));
    if (sessionData) {
      updateProfile(sessionData);
    }
  } catch (e) {
    console.error('Session Storage Error:', e);
  }

  // Update based on Firebase Auth
  firebase.auth().onAuthStateChanged(function(user) {
    if (user) {
      // Save user details into sessionStorage
      const userDetails = {
        uid: user.uid,
        displayName: user.displayName,
        email: user.email,
        photoURL: user.photoURL
      };
      sessionStorage.setItem('userDetails', JSON.stringify(userDetails));

      updateProfile(user);
    } else {
      sessionStorage.removeItem('userDetails');
      updateProfile(null);
    }
  });

  // Handle logout
  function handleLogout() {
    window.location.href = '/logout';
  }
</script>
  <div id="main-container" class="flex h-[calc(100vh-64px)]">
    <div id="projects-container" class="container mx-auto p-8 text-text-color">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-3xl font-bold">My Projects</h2>
    <button id="new-project-btn" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded shadow transition duration-150 ease-in-out">
      New Project
    </button>
  </div>

  <!-- Loading Indicator -->
  <div id="loading-indicator" class="text-center py-10 hidden">
    <div class="loader inline-block"></div>
    <p class="mt-2">Loading projects...</p>
  </div>

  <!-- Empty State -->
  <div id="empty-state" class="text-center py-10 hidden">
    <p class="text-xl text-gray-500">You don't have any projects yet.</p>
    <p class="mt-2">Click "New Project" to get started!</p>
  </div>

  <!-- Project Grid -->
  <div id="project-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
    <!-- Project cards will be dynamically inserted here -->
    <!-- Example Project Card Structure (for reference) -->
    <!--
    <div class="project-card" data-project-name="MyFirstProject">
      <h3 class="text-xl font-semibold mb-2">MyFirstProject</h3>
      <p class="text-sm text-gray-400">Last modified: [Date]</p>
    </div>
    -->
  </div>
</div>
  </div>

  {% include 'partials/context_menu.html' %}

  <!-- Include Firebase setup if not already globally available via base.html -->
  <script src="{{ url_for('static', filename='js/firebase.js') }}"></script>
  <!-- Include the specific JS for this page -->
  <script src="{{ url_for('static', filename='js/projects.js') }}"></script>
  <script>
    // Basic auth check for the projects page
    firebase.auth().onAuthStateChanged(function(user) {
      if (!user) {
        window.location.href = "/login"; // Redirect to login if not authenticated
      } else {
        // User is logged in, proceed to load projects (handled in projects.js)
        console.log("User authenticated for projects page.");
      }
    });
  </script>
  <script>
    // Theme handling for dialog
    function updateDialogTheme() {
        const theme = document.getElementById('theme-selector').value;
        document.documentElement.setAttribute('data-theme', theme);
    }

    // Listen for theme changes
    document.getElementById('theme-selector').addEventListener('change', updateDialogTheme);
    
    // Set initial theme
    updateDialogTheme();
  </script>
</body>
</html>